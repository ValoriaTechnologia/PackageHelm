name: "Integration Tests"
on:
  workflow_call:

permissions:
  contents: read

jobs:
  integration:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create test chart
        run: |
          mkdir -p test-chart/templates dist
          cat > test-chart/Chart.yaml <<'EOF'
          apiVersion: v2
          name: test-chart
          description: Test chart
          type: application
          version: 0.1.0
          appVersion: "0.1.0"
          EOF
          cat > test-chart/values.yaml <<'EOF'
          replicaCount: 1
          nested:
            keep: keepme
            a: 1
          lst:
            - 1
            - 2
          foo: base
          EOF
          cat > test-chart/values.dev.yaml <<'EOF'
          nested:
            a: 9
            b: 2
          lst:
            - 3
          foo: override
          EOF
          cat > test-chart/templates/configmap.yaml <<'EOF'
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: test
          data:
            hello: world
          EOF

      - name: Run action
        id: pkg
        uses: ./
        with:
          chart_path: ./test-chart
          values_files: |
            values.yaml
            values.dev.yaml
          destination: ./dist
          helm_version: v3.14.4
          helm_chart_version: 1.2.3
          helm_chart_app_version: 4.5.6

      - name: Assert package exists and is readable
        run: |
          test -f "${{ steps.pkg.outputs.package_path }}"
          tar -tzf "${{ steps.pkg.outputs.package_path }}" >/dev/null

      - name: Assert merged values are embedded
        run: |
          rm -rf extracted
          mkdir -p extracted
          tar -xzf "${{ steps.pkg.outputs.package_path }}" -C extracted
          test -f extracted/test-chart/values.yaml
          grep -q "foo: override" extracted/test-chart/values.yaml
          grep -q "keep: keepme" extracted/test-chart/values.yaml
          grep -q "a: 9" extracted/test-chart/values.yaml
          grep -q "b: 2" extracted/test-chart/values.yaml
          grep -q -- "- 3" extracted/test-chart/values.yaml

